<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador Interactivo de Funciones Trigonom√©tricas</title>
    
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Cargar librer√≠a para evaluar expresiones matem√°ticas (pi) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.min.js"></script>
    
    <!-- Cargar Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Definir variables CSS para los colores de la paleta */
        :root {
            --color-dark-blue: #2C4870;
            --color-dark-teal: #1E5A54;
            --color-light-gray: #F2F2F2;
            --color-medium-blue: #4A8ABD;
            --color-vibrant-blue: #2C4870; 
            --color-yellow: #F4CA52;
            --color-red: #DC2626;
            --color-light-red: #EF4444;
        }

        body {
            background-color: var(--color-light-gray); /* Fondo general gris claro */
            color: var(--color-dark-blue); /* Texto principal azul oscuro */
        }
        
        /* Estilo personalizado para los deslizadores */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db; /* gray-300 para el fondo del slider */
            border-radius: 5px;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-medium-blue); /* Thumb del slider en azul medio */
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-medium-blue); /* Thumb del slider en azul medio */
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Estilos para el input num√©rico */
        .value-input {
            width: 5rem;
            padding: 0.25rem 0.5rem;
            font-family: 'Inter', monospace;
            font-size: 0.875rem;
            color: white;
            background-color: var(--color-medium-blue);
            border: 1px solid var(--color-dark-blue);
            border-radius: 0.375rem;
            text-align: center;
        }
        .value-input:focus {
            outline: 2px solid var(--color-yellow);
            background-color: var(--color-dark-blue);
        }

        /* Estilo para los botones de presets */
        .preset-btn {
            background-color: var(--color-dark-teal);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .preset-btn:hover {
            background-color: #2a8a80;
        }
        .preset-btn.active {
            background-color: var(--color-medium-blue);
            box-shadow: 0 0 0 2px var(--color-yellow);
        }

        /* Estilo para los checkboxes */
        .styled-checkbox {
            color: var(--color-medium-blue);
        }
        .styled-checkbox:focus {
            ring-color: var(--color-medium-blue);
        }

        /* Estilos para el nuevo bot√≥n de IA */
        .btn-ai {
            background-color: var(--color-medium-blue);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            border: 2px solid var(--color-dark-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-ai:hover {
            background-color: var(--color-dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Estilos para el Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #FFFFFF; /* CORREGIDO: Usar blanco fijo en lugar de var(--color-white) */
            color: var(--color-dark-blue);
            padding: 1.5rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-close-btn {
            background-color: var(--color-light-gray);
            color: var(--color-dark-blue);
            border-radius: 99px;
            padding: 0.25rem 0.75rem;
            font-weight: bold;
            float: right;
            cursor: pointer;
        }
        .modal-close-btn:hover {
            background-color: #d1d5db;
        }
        
        /* --- NUEVO --- Estilos para la respuesta de IA en el modal */
        .modal-content .ai-response {
            line-height: 1.6; /* Mejor interlineado */
            font-size: 0.95rem;
        }
        .modal-content .ai-response p {
            margin-bottom: 0.75rem; /* Espacio entre p√°rrafos */
            color: #333; /* Un gris oscuro para mejor legibilidad */
        }
        /* --- FIN DE NUEVO --- */

        /* Loader para el modal */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--color-medium-blue);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin: 2rem auto;
            display: block;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
        
        <!-- Encabezado -->
        <header class="p-6 bg-[var(--color-dark-blue)] text-white border-b-4 border-[var(--color-medium-blue)]">
            <h1 class="text-2xl md:text-3xl font-bold text-center">Explorador Interactivo de Funciones Trigonom√©tricas</h1>
            <p class="text-center text-sm text-gray-300 mt-1">f(x) = a ¬∑ func(b(x - c)) + d</p>
        </header>

        <div class="md:grid md:grid-cols-3">
            
            <!-- Panel Lateral de Controles -->
            <aside class="md:col-span-1 p-6 bg-[var(--color-light-gray)] border-r border-gray-200">
                <h2 class="text-xl font-semibold mb-6 border-b pb-2 border-gray-300">üìä Controles y Par√°metros</h2>

                <!-- Selector de Funci√≥n Base -->
                <div class="mb-6">
                    <label class="block font-medium mb-2">üåä Funci√≥n Base:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center text-[var(--color-dark-blue)]">
                            <input type="radio" name="funcType" value="sin" id="funcSin" class="styled-checkbox focus:ring-[var(--color-medium-blue)]" checked>
                            <span class="ml-2">Seno (sin)</span>
                        </label>
                        <label class="flex items-center text-[var(--color-dark-blue)]">
                            <input type="radio" name="funcType" value="cos" id="funcCos" class="styled-checkbox focus:ring-[var(--color-medium-blue)]">
                            <span class="ml-2">Coseno (cos)</span>
                        </label>
                    </div>
                </div>

                <!-- Deslizadores y Entradas Num√©ricas -->
                <div class="space-y-6">
                    <!-- Par√°metro a (Amplitud) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="sliderA" class="font-medium">‚ÜïÔ∏è a (Amplitud)</label>
                            <input type="number" id="valueA" class="value-input" step="0.1" value="1.0">
                        </div>
                        <input type="range" id="sliderA" min="-10" max="10" value="1" step="0.1" data-param="a">
                    </div>

                    <!-- Par√°metro b (Frecuencia) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="sliderB" class="font-medium">‚ÜîÔ∏è b (Frecuencia)</label>
                            <input type="text" id="valueB" class="value-input" value="1.0">
                        </div>
                        <input type="range" id="sliderB" min="0.1" max="10" value="1" step="0.1" data-param="b">
                    </div>

                    <!-- Par√°metro c (Desplazamiento de Fase) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="sliderC" class="font-medium">‚û°Ô∏è c (Desplazamiento de Fase)</label>
                            <input type="text" id="valueC" class="value-input" value="0.0">
                        </div>
                        <input type="range" id="sliderC" min="-6.28" max="6.28" value="0" step="0.01" data-param="c">
                        <div class="text-xs text-gray-500 flex justify-between"><span>-2œÄ</span><span>0</span><span>2œÄ</span></div>
                    </div>

                    <!-- Par√°metro d (Desplazamiento Vertical) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="sliderD" class="font-medium">‚¨ÜÔ∏è d (Desplazamiento Vertical)</label>
                            <input type="number" id="valueD" class="value-input" step="0.1" value="0.0">
                        </div>
                        <input type="range" id="sliderD" min="-5" max="5" value="0" step="0.1" data-param="d">
                    </div>
                </div>
                
                <!-- Presets (Modelos Predefinidos) -->
                <div class="mt-8">
                    <h3 class="font-medium mb-2">Modelos Predefinidos:</h3>
                    <div class="flex flex-wrap gap-2">
                        <button id="btnPresetNoria" class="preset-btn">üé° Noria</button>
                        <button id="btnPresetMarea" class="preset-btn">üåä Marea</button>
                        <button id="btnPresetReset" class="preset-btn bg-gray-500 hover:bg-gray-600">üîÑ Resetear</button>
                    </div>
                </div>
            </aside>

            <!-- Panel Principal (Gr√°fica e Informaci√≥n) -->
            <main class="md:col-span-2 p-6">
                
                <!-- Ecuaci√≥n Din√°mica -->
                <div class="mb-4 p-4 bg-[var(--color-dark-blue)] text-white rounded-lg shadow-inner">
                    <p id="dynamicEquation" class="text-xl md:text-2xl font-mono text-center text-[var(--color-yellow)]"></p>
                </div>

                <!-- Contenedor del Gr√°fico -->
                <div class="w-full h-64 md:h-96 mb-6 relative">
                    <canvas id="trigChart"></canvas>
                </div>
                
                <!-- Opciones de Visualizaci√≥n -->
                <div class="flex flex-wrap gap-4 items-center mb-6">
                     <label class="flex items-center text-[var(--color-dark-blue)] cursor-pointer">
                        <input type="checkbox" id="checkShowKeyPoints" class="styled-checkbox h-4 w-4 focus:ring-2">
                        <span class="ml-2">üìç Marcar Puntos Clave (Max/Min)</span>
                    </label>
                    <label class="flex items-center text-[var(--color-dark-blue)] cursor-pointer">
                        <input type="checkbox" id="checkShowSolver" class="styled-checkbox h-4 w-4 focus:ring-2">
                        <span class="ml-2">üîç Mostrar solucionador (y=k)</span>
                    </label>
                </div>
                
                <!-- Deslizador del Solucionador (k) -->
                <div id="solverContainer" class="space-y-2 mb-6 hidden">
                    <div class="flex justify-between items-center">
                        <label for="sliderK" class="font-medium text-red-700">üîç Resolver para y = k</label>
                        <input type="number" id="valueK" class="value-input !bg-red-600 !border-red-800" step="0.1" value="1.0">
                    </div>
                    <input type="range" id="sliderK" min="-10" max="10" value="1" step="0.1" data-param="k" class="[&::-webkit-slider-thumb]:!bg-red-600 [&::-moz-range-thumb]:!bg-red-600">
                </div>

                <!-- Panel de Informaci√≥n -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-[var(--color-light-gray)] p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-600 uppercase">‚ÜïÔ∏è Amplitud</h3>
                        <p id="infoAmplitude" class="text-2xl font-bold text-[var(--color-dark-blue)]">1.0</p>
                    </div>
                    <div class="bg-[var(--color-light-gray)] p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-600 uppercase">‚ÜîÔ∏è Per√≠odo</h3>
                        <p id="infoPeriod" class="text-2xl font-bold text-[var(--color-dark-blue)]">2œÄ (6.28)</p>
                    </div>
                    <div class="bg-[var(--color-light-gray)] p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-600 uppercase">üìè L√≠nea Media</h3>
                        <p id="infoMidline" class="text-2xl font-bold text-[var(--color-dark-blue)]">y = 0.0</p>
                    </div>
                    <div class="bg-[var(--color-light-gray)] p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="text-sm font-semibold text-gray-600 uppercase">üìà Rango</h3>
                        <p id="infoRange" class="text-xl font-bold text-[var(--color-dark-blue)]">[-1.0, 1.0]</p>
                </div>
            </div>

            <!-- Bot√≥n de An√°lisis con IA -->
            <div class="mt-6">
                <button id="btnAnalyzeAI" class="btn-ai">
                    ‚ú® Analizar mi Funci√≥n con IA
                </button>
            </div>
                
            <!-- Panel de Explicaciones -->
                <div id="explanationPanel" class="mt-6 p-4 bg-yellow-50 border-l-4 border-[var(--color-yellow)] text-gray-700 rounded-r-lg">
                    <h4 class="font-bold text-gray-800">üí° ¬øQu√© hace este par√°metro?</h4>
                    <p id="explanationText">Mueve los deslizadores o haz clic en un preset para ver una explicaci√≥n.</p>
                </div>
            </main>

        </div>
    </div>

    <!-- Pie de P√°gina -->
    <footer class="mt-8 p-4 text-center text-sm text-gray-600">
        <div class="flex flex-col sm:flex-row items-center justify-center sm:space-x-2 gap-y-2 sm:gap-y-0">
            <!-- Contenedor para el nombre y enlace -->
            <div class="flex items-center justify-center space-x-1.5">
                <span>2025 - Desarrollado por</span>
                <a href="https://www.linkedin.com/in/javiertrigosojrtt/" target="_blank" rel="noopener noreferrer" 
                   class="flex items-center font-medium text-[var(--color-dark-blue)] hover:text-[var(--color-medium-blue)] transition-colors">
                    <span>Javier Trigoso</span>
                    <!-- LinkedIn SVG Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.785-1.75-1.75s.784-1.75 1.75-1.75 1.75.785 1.75 1.75-.784 1.75-1.75 1.75zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                    </svg>
                </a>
                <span>- SPVC.</span>
            </div>
            
            <!-- Contenedor para la licencia -->
            <div class="flex items-center space-x-1" title="CC BY-NC-SA (Atribuci√≥n - No Comercial - Compartir Igual)">
                <!-- Icono CC -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M9.78 14.23c.32.2 1.13.8 1.13 1.67 0 .8-.5 1.02-1.03.92-.62-.1-1.3-.6-1.54-1.1-.12-.25-.04-.5.2-.6l.7-.4c.2-.1.5 0 .6.2.1.2.3.4.5.6.3.2.7.2 1.04 0 .04 0 0 0 0 0zm4.4-1.1c-.24.5-.9 1-1.5 1.1-.5.1-1.04-.1-1.04-.9 0-.9.8-1.5 1.1-1.7.3-.2.8-.2 1 0l.7.4c.2.1.3.4.2.6l-.1.2c-.2-.2-.4-.4-.6-.5-.3-.2-.7-.2-1 0 0 0 0 0 0 0zM12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>
                <!-- Icono BY (Atribuci√≥n) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 6c-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3-1.3-3-3-3zm0 7c-2.2 0-4 1.8-4 4v1c0 .6.4 1 1 1h6c.6 0 1-.4 1-1v-1c0-2.2-1.8-4-4-4z"/></svg>
                <!-- Icono NC (No Comercial) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M16.14 7.86l-8.28 8.28c-.39.39-1.02.39-1.41 0l-.71-.71c-.39-.39-.39-1.02 0-1.41l8.28-8.28c.39-.39 1.02-.39 1.41 0l.71.71c.39.39.39 1.02 0 1.41zM9.1 10.5v1H8v-1c0-.8-.7-1.5-1.5-1.5H6v5h.5c.8 0 1.5-.7 1.5-1.5v-1h1v1c0 .8.7 1.5 1.5 1.5H12v-5h-.5c-.8 0-1.5.7-1.5 1.5zm6.4 0H15v5h.5c.8 0 1.5-.7 1.5-1.5v-2c0-.8-.7-1.5-1.5-1.5z"/></svg>
                <!-- Icono SA (Compartir Igual) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M17.65 6.35C16.2 4.9 14.2 4 12 4c-3.53 0-6.43 2.61-6.92 6H7.8c.41-1.92 2.05-3.36 4.2-3.36 1.7 0 3.1 1.03 3.75 2.5l-2.45-2.45c-.39-.39-.39-1.02 0-1.41l.71-.71c.39-.39 1.02-.39 1.41 0L19.8 8.4c.39.39.39 1.02 0 1.41l-3.85 3.85c-.39-.39-1.02.39-1.41 0l-.71-.71c-.39-.39-.39-1.02 0-1.41l2.45-2.45c-.65-1.47-2.05-2.5-3.75-2.5-2.15 0-3.79 1.44-4.2 3.36H5.08c.49-3.39 3.39-6 6.92-6 2.2 0 4.2 0.9 5.65 2.35zM12 20c3.53 0 6.43-2.61 6.92-6H16.2c-.41 1.92-2.05 3.36-4.2 3.36-1.7 0-3.1-1.03-3.75-2.5l2.45 2.45c.39.39.39 1.02 0 1.41l-.71.71c-.39-.39-1.02.39-1.41 0L4.2 15.6c-.39-.39-.39-1.02 0-1.41l3.85-3.85c.39-.39 1.02-.39 1.41 0l.71.71c.39.39.39 1.02 0 1.41l-2.45 2.45c.65 1.47 2.05 2.5 3.75 2.5 2.15 0 3.79-1.44 4.2-3.36h2.84c-.49 3.39-3.39 6-6.92 6z"/></svg>
            </div>
            <span>(CC BY-NC-SA)</span>
        </div>
    </footer>

    <!-- Modal de IA -->
    <div id="aiModal" class="modal-overlay">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close-btn">X</button>
            <h2 class="text-xl font-bold text-[var(--color-dark-blue)] mb-4">An√°lisis de la IA</h2>
            <div id="modalBody">
                <!-- El contenido (loader o respuesta) se insertar√° aqu√≠ -->
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar el parser de math.js
        const parser = math.parser();

        // Obtener elementos del DOM
        const sliders = {
            a: document.getElementById('sliderA'),
            b: document.getElementById('sliderB'),
            c: document.getElementById('sliderC'),
            d: document.getElementById('sliderD'),
            k: document.getElementById('sliderK')
        };
        
        const values = {
            a: document.getElementById('valueA'),
            b: document.getElementById('valueB'),
            c: document.getElementById('valueC'),
            d: document.getElementById('valueD'),
            k: document.getElementById('valueK')
        };
        
        const funcSin = document.getElementById('funcSin');
        const funcCos = document.getElementById('funcCos');
        
        const dynamicEquation = document.getElementById('dynamicEquation');
        
        const info = {
            amplitude: document.getElementById('infoAmplitude'),
            period: document.getElementById('infoPeriod'),
            midline: document.getElementById('infoMidline'),
            range: document.getElementById('infoRange')
        };
        
        const checks = {
            keyPoints: document.getElementById('checkShowKeyPoints'),
            solver: document.getElementById('checkShowSolver')
        };
        
        const solverContainer = document.getElementById('solverContainer');
        
        const explanationPanel = document.getElementById('explanationPanel');
        const explanationText = document.getElementById('explanationText');
        
        // --- Elementos de IA y Modal ---
        const btnAnalyzeAI = document.getElementById('btnAnalyzeAI');
        const aiModal = document.getElementById('aiModal');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const modalBody = document.getElementById('modalBody');

        const presets = {
            noria: document.getElementById('btnPresetNoria'),
            marea: document.getElementById('btnPresetMarea'),
            reset: document.getElementById('btnPresetReset')
        };
        
        const ctx = document.getElementById('trigChart').getContext('2d');
        let trigChart;
        let activePreset = null;

        // Colores de la paleta para Chart.js
        const chartColors = {
            darkBlue: '#2C4870',
            darkTeal: '#1E5A54',
            lightGray: '#F2F2F2',
            mediumBlue: '#4A8ABD',
            yellow: '#F4CA52',
            red: '#DC2626',
            lightRed: '#EF4444'
        };

        const explanations = {
            a: "<b>'a' (Amplitud):</b> Estira o comprime la gr√°fica verticalmente. Si 'a' es negativo, la gr√°fica se invierte. La amplitud es el valor absoluto, |a|.",
            b: "<b>'b' (Frecuencia):</b> Cambia el per√≠odo (la longitud de un ciclo completo). Un valor de 'b' m√°s grande comprime la gr√°fica horizontalmente (per√≠odo m√°s corto). El per√≠odo se calcula como 2œÄ / |b|.",
            c: "<b>'c' (Desplazamiento de Fase):</b> Mueve la gr√°fica horizontalmente. Si 'c' es positivo (como en x - c), la gr√°fica se mueve hacia la derecha. Si 'c' es negativo (como en x + c), se mueve a la izquierda.",
            d: "<b>'d' (Desplazamiento Vertical):</b> Mueve la gr√°fica verticalmente. Este valor determina la 'L√≠nea Media' o el eje central de la oscilaci√≥n.",
            k: "<b>'k' (Solucionador):</b> Esta l√≠nea horizontal representa un valor constante. Los puntos rojos marcan las soluciones de la ecuaci√≥n f(x) = k.",
            noria: "<b>Preset: Noria</b><br>Este modelo (y = -10cos(œÄt/15) + 12) simula una noria con un radio de 10m, que parte desde el punto m√°s bajo (por eso 'a' es negativo y se usa coseno) y tarda 30 segundos en dar una vuelta completa (Per√≠odo = 2œÄ / (œÄ/15) = 30). La plataforma est√° a 2m del suelo (12 - 10 = 2).",
            marea: "<b>Preset: Marea</b><br>Este modelo (y = 1.5sin(œÄt/6) + 3) simula el nivel de la marea. Tiene una amplitud de 1.5m (la marea sube/baja 1.5m desde el promedio) y un per√≠odo de 12 horas (Per√≠odo = 2œÄ / (œÄ/6) = 12). El nivel promedio del agua es de 3m.",
            reset: "Valores reiniciados a la funci√≥n base."
        };

        // --- FUNCIONES DE C√ÅLCULO Y GR√ÅFICO ---

        // Funci√≥n para generar los datos de la gr√°fica
        function generateData(params) {
            const { a, b, c, d, funcType, k } = params;
            const data = [];
            const midlineData = [];
            const parentData = [];
            const solverData = [];
            
            const step = 0.01; // Paso m√°s fino para mejor detecci√≥n
            const range = { min: -2 * Math.PI, max: 2 * Math.PI };

            let func, parentFunc;
            if (funcType === 'sin') {
                func = (x) => a * Math.sin(b * (x - c)) + d;
                parentFunc = Math.sin;
            } else {
                func = (x) => a * Math.cos(b * (x - c)) + d;
                parentFunc = Math.cos;
            }

            for (let x = range.min; x <= range.max; x += step) {
                data.push({ x: x, y: func(x) });
                midlineData.push({ x: x, y: d });
                parentData.push({ x: x, y: parentFunc(x) });
                solverData.push({ x: x, y: k });
            }
            
            return { data, midlineData, parentData, solverData, func, range };
        }
        
        // Funci√≥n para encontrar puntos clave (Max/Min)
        function findKeyPoints(func, range, a, d) {
            const maxPoints = [];
            const minPoints = [];
            if (a === 0) return { maxPoints, minPoints }; // Evitar si no hay amplitud

            const step = 0.01;
            let prevY = func(range.min);

            for (let x = range.min + step; x <= range.max; x += step) {
                const currY = func(x);
                const nextY = func(x + step);

                // Encontrar m√°ximo (pico)
                if (currY > prevY && currY > nextY && Math.abs(currY - (d + Math.abs(a))) < 0.01) {
                    maxPoints.push({ x: x, y: currY });
                }
                // Encontrar m√≠nimo (valle)
                if (currY < prevY && currY < nextY && Math.abs(currY - (d - Math.abs(a))) < 0.01) {
                    minPoints.push({ x: x, y: currY });
                }
                prevY = currY;
            }
            return { maxPoints, minPoints };
        }
        
        // Funci√≥n para encontrar intersecciones (f(x) = k)
        function findIntersections(func, range, k) {
            const intersections = [];
            const step = 0.01;
            let prevY = func(range.min);

            for (let x = range.min + step; x <= range.max; x += step) {
                const currY = func(x);
                // Comprobar si la l√≠nea 'k' ha sido cruzada
                if ((prevY < k && currY >= k) || (prevY > k && currY <= k)) {
                    // Simple interpolaci√≥n lineal para mejor precisi√≥n
                    const intersectX = x - step * (currY - k) / (currY - prevY);
                    intersections.push({ x: intersectX, y: k });
                }
                prevY = currY;
            }
            return intersections;
        }


        // Funci√≥n para inicializar el gr√°fico
        function initChart() {
            trigChart = new Chart(ctx, {
                type: 'scatter', // Usar 'scatter' permite datos {x, y}
                data: {
                    datasets: [
                        { // 0: Funci√≥n Padre
                            label: 'Funci√≥n Padre',
                            data: [],
                            borderColor: 'rgba(150, 150, 150, 0.5)',
                            borderWidth: 2,
                            pointRadius: 0,
                            showLine: true,
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        { // 1: L√≠nea Media
                            label: 'L√≠nea Media (y = d)',
                            data: [],
                            borderColor: chartColors.darkTeal,
                            borderWidth: 2,
                            pointRadius: 0,
                            showLine: true,
                            borderDash: [3, 3],
                        },
                        { // 2: Funci√≥n Transformada
                            label: 'Funci√≥n Transformada f(x)',
                            data: [],
                            borderColor: chartColors.mediumBlue,
                            borderWidth: 3,
                            pointRadius: 0,
                            showLine: true,
                            tension: 0.1
                        },
                        { // 3: Puntos M√°ximos
                            label: 'Puntos Clave (Max/Min)',
                            data: [],
                            backgroundColor: chartColors.yellow,
                            borderColor: chartColors.darkBlue,
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                            hidden: true,
                        },
                        { // 4: Puntos M√≠nimos (mismo dataset que Max)
                            data: [],
                            backgroundColor: chartColors.yellow,
                            borderColor: chartColors.darkBlue,
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                            hidden: true,
                        },
                        { // 5: L√≠nea del Solucionador (y = k)
                            label: 'Solucionador (y = k)',
                            data: [],
                            borderColor: chartColors.red,
                            borderWidth: 2,
                            pointRadius: 0,
                            showLine: true,
                            borderDash: [5, 5],
                            hidden: true,
                        },
                        { // 6: Puntos de Intersecci√≥n
                            label: 'Intersecciones f(x) = k',
                            data: [],
                            backgroundColor: chartColors.lightRed,
                            borderColor: chartColors.red,
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            showLine: false,
                            hidden: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            min: -2 * Math.PI,
                            max: 2 * Math.PI,
                            title: {
                                display: true,
                                text: 'x (radianes)',
                                color: chartColors.darkBlue
                            },
                            grid: {
                                color: '#e5e7eb' // gray-200
                            },
                            ticks: {
                                color: chartColors.darkBlue,
                                stepSize: Math.PI / 2, // Marcas cada œÄ/2
                                callback: function(value, index, values) {
                                    const multiples = value / Math.PI;
                                    if (multiples === 0) return '0';
                                    if (multiples === 1) return 'œÄ';
                                    if (multiples === -1) return '-œÄ';
                                    if (multiples === 2) return '2œÄ';
                                    if (multiples === -2) return '-2œÄ';
                                    if (multiples === 0.5) return 'œÄ/2';
                                    if (multiples === -0.5) return '-œÄ/2';
                                    if (multiples === 1.5) return '3œÄ/2';
                                    if (multiples === -1.5) return '-3œÄ/2';
                                    return null; // Ocultar otras marcas
                                }
                            }
                        },
                        y: {
                            min: -10,
                            max: 10,
                            title: {
                                display: true,
                                text: 'y',
                                color: chartColors.darkBlue
                            },
                            grid: {
                                color: '#e5e7eb' // gray-200
                            },
                            ticks: {
                                color: chartColors.darkBlue
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                color: chartColors.darkBlue,
                                // Filtrar leyendas que no queremos mostrar
                                filter: function(legendItem, chartData) {
                                    // Ocultar la leyenda del dataset 4 (Min)
                                    return legendItem.datasetIndex !== 4;
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: chartColors.darkBlue,
                            titleColor: chartColors.yellow,
                            bodyColor: chartColors.lightGray,
                            borderColor: chartColors.mediumBlue,
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `(${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 0 // Sin animaci√≥n en updates
                    }
                }
            });
        }
        
        // --- FUNCIONES DE ACTUALIZACI√ìN (UI Y ESTADO) ---

        // Funci√≥n principal para actualizar todo
        function updateApplication(focusedParam = null) {
            const params = readParameters();
            
            // Actualizar Ecuaci√≥n y Panel de Informaci√≥n
            updateInfoPanel(params);
            updateDynamicEquation(params);
            
            // Generar datos y actualizar gr√°fico
            const { data, midlineData, parentData, solverData, func, range } = generateData(params);
            
            trigChart.data.datasets[0].data = parentData;
            trigChart.data.datasets[1].data = midlineData;
            trigChart.data.datasets[2].data = data;
            
            // Actualizar Puntos Clave
            if (checks.keyPoints.checked) {
                const { maxPoints, minPoints } = findKeyPoints(func, range, params.a, params.d);
                trigChart.data.datasets[3].data = maxPoints;
                trigChart.data.datasets[4].data = minPoints;
                trigChart.data.datasets[3].hidden = false;
                trigChart.data.datasets[4].hidden = false;
            } else {
                trigChart.data.datasets[3].hidden = true;
                trigChart.data.datasets[4].hidden = true;
            }
            
            // Actualizar Solucionador
            if (checks.solver.checked) {
                solverContainer.classList.remove('hidden');
                trigChart.data.datasets[5].hidden = false;
                trigChart.data.datasets[6].hidden = false;
                
                trigChart.data.datasets[5].data = solverData;
                trigChart.data.datasets[6].data = findIntersections(func, range, params.k);
            } else {
                solverContainer.classList.add('hidden');
                trigChart.data.datasets[5].hidden = true;
                trigChart.data.datasets[6].hidden = true;
            }
            
            // Ajustar din√°micamente el eje Y
            const yMin = params.d - Math.abs(params.a) - 1;
            const yMax = params.d + Math.abs(params.a) + 1;
            const kVal = params.k;
            
            // Asegurar que el rango del eje Y incluya la funci√≥n y la l√≠nea k
            const finalYMin = Math.min(yMin, kVal - 1, -10);
            const finalYMax = Math.max(yMax, kVal + 1, 10);
            
            trigChart.options.scales.y.min = Math.floor(finalYMin);
            trigChart.options.scales.y.max = Math.ceil(finalYMax);

            trigChart.update();
            
            // Actualizar explicaci√≥n
            if (focusedParam) {
                showExplanation(focusedParam);
            }
        }

        // Leer par√°metros desde la UI
        function readParameters() {
            const params = {
                a: parseFloat(values.a.value),
                d: parseFloat(values.d.value),
                k: parseFloat(values.k.value),
                funcType: funcSin.checked ? 'sin' : 'cos'
            };

            // Intentar parsear 'b' y 'c' con math.js
            try {
                params.b = parser.evaluate(values.b.value);
            } catch (e) {
                params.b = 1; // Valor por defecto en caso de error
                values.b.value = "1";
            }
            
            try {
                params.c = parser.evaluate(values.c.value);
            } catch (e) {
                params.c = 0; // Valor por defecto
                values.c.value = "0";
            }
            
            return params;
        }

        // Actualizar panel de informaci√≥n
        function updateInfoPanel(params) {
            const { a, b, d } = params;
            const amplitude = Math.abs(a);
            const period = (b === 0) ? 'Infinito' : (2 * Math.PI / Math.abs(b));
            
            info.amplitude.textContent = amplitude.toFixed(2);
            info.period.textContent = `${period.toFixed(2)} (‚âà ${formatPi(period)})`;
            info.midline.textContent = `y = ${d.toFixed(2)}`;
            info.range.textContent = `[${(d - amplitude).toFixed(2)}, ${(d + amplitude).toFixed(2)}]`;
        }

        // Actualizar ecuaci√≥n din√°mica
        function updateDynamicEquation(params) {
            const { a, b, c, d, funcType } = params;
            
            // Formatear par√°metros para la ecuaci√≥n
            const aStr = a.toFixed(1);
            const funcStr = funcType === 'sin' ? 'sin' : 'cos';
            
            // Formatear b
            let bStr = (b === 1) ? '' : `${Math.abs(b).toFixed(2)}`;
            if (b < 0) bStr = `-${bStr}`;
            
            // Formatear c
            let cStr = '';
            if (c > 0.001) cStr = ` - ${c.toFixed(2)}`;
            if (c < -0.001) cStr = ` + ${Math.abs(c).toFixed(2)}`;
            
            // Formatear d
            let dStr = '';
            if (d > 0.001) dStr = ` + ${d.toFixed(2)}`;
            if (d < -0.001) dStr = ` - ${Math.abs(d).toFixed(2)}`;

            dynamicEquation.textContent = `y = ${aStr} ¬∑ ${funcStr}(${bStr}(x${cStr}))${dStr}`;
        }
        
        // Mostrar explicaci√≥n
        function showExplanation(param) {
            if (explanations[param]) {
                explanationPanel.classList.remove('bg-yellow-50', 'border-[var(--color-yellow)]');
                explanationPanel.classList.add('bg-blue-50', 'border-[var(--color-medium-blue)]');
                explanationText.innerHTML = explanations[param];
            }
        }
        
        // --- FUNCIONES DE SINCRONIZACI√ìN Y UTILIDADES ---

        // Sincronizar slider y value box
        function syncSlider(slider, valueBox) {
            let val = parseFloat(valueBox.value);
            if (isNaN(val)) val = 1; // Default
            
            // Manejar valores especiales para 'b' y 'c'
            if (valueBox.id === 'valueB' || valueBox.id === 'valueC') {
                try {
                    val = parser.evaluate(valueBox.value);
                } catch (e) {
                    val = (valueBox.id === 'valueB') ? 1 : 0;
                }
            }
            
            if (val > slider.max) slider.max = val;
            if (val < slider.min) slider.min = val;
            slider.value = val;
        }

        function syncValueBox(slider, valueBox) {
            const val = parseFloat(slider.value);
            // Formatear 'b' y 'c' con œÄ si es posible
            if (valueBox.id === 'valueB' || valueBox.id === 'valueC') {
                valueBox.value = formatPi(val);
            } else {
                valueBox.value = val.toFixed(1);
            }
        }
        
        // Formatear n√∫meros en t√©rminos de Pi (si es cercano)
        function formatPi(value) {
            const pi = Math.PI;
            const tolerance = 0.01;
            const multiples = [
                { val: pi / 4, str: "œÄ/4" }, { val: pi / 3, str: "œÄ/3" }, { val: pi / 2, str: "œÄ/2" },
                { val: pi, str: "œÄ" }, { val: 3 * pi / 2, str: "3œÄ/2" }, { val: 2 * pi, str: "2œÄ" }
            ];
            
            for (const m of multiples) {
                if (Math.abs(value - m.val) < tolerance) return m.str;
                if (Math.abs(value + m.val) < tolerance) return `-${m.str}`;
            }
            return value.toFixed(2); // Retorno por defecto
        }
        
        // Cargar un preset
        function loadPreset(presetKey) {
            // Quitar clase 'active' de todos
            Object.values(presets).forEach(btn => btn.classList.remove('active'));
            
            const params = {
                noria: { a: -10, b: "pi/15", c: "0", d: 12, funcType: 'cos', k: 2, keyPoints: true, solver: true },
                marea: { a: 1.5, b: "pi/6", c: "0", d: 3, funcType: 'sin', k: 4.5, keyPoints: true, solver: true },
                reset: { a: 1, b: "1", c: "0", d: 0, funcType: 'sin', k: 1, keyPoints: false, solver: false }
            };
            
            const p = params[presetKey];
            if (!p) return;
            
            // Marcar el bot√≥n activo (excepto reset)
            if (presetKey !== 'reset') {
                presets[presetKey].classList.add('active');
                activePreset = presetKey;
            } else {
                activePreset = null;
            }

            // Establecer valores
            values.a.value = p.a;
            values.b.value = p.b;
            values.c.value = p.c;
            values.d.value = p.d;
            values.k.value = p.k;
            
            funcSin.checked = p.funcType === 'sin';
            funcCos.checked = p.funcType === 'cos';
            
            checks.keyPoints.checked = p.keyPoints;
            checks.solver.checked = p.solver;
            
            // Sincronizar sliders
            Object.keys(sliders).forEach(key => {
                if (values[key]) {
                    syncSlider(sliders[key], values[key]);
                }
            });
            
            // Actualizar aplicaci√≥n y mostrar explicaci√≥n
            updateApplication(presetKey);
        }

        // --- FUNCIONES DE IA (GEMINI) ---

        /**
         * Muestra el modal
         */
        function showModal() {
            aiModal.classList.add('visible');
        }

        /**
         * Oculta el modal
         */
        function hideModal() {
            aiModal.classList.remove('visible');
        }

        /**
         * Muestra el indicador de carga en el modal
         */
        function showLoader() {
            modalBody.innerHTML = '<div class="loader"></div>';
        }

        /**
         * Llama a la API de Gemini con reintentos
         * @param {string} prompt El prompt para la IA
         * @param {number} maxRetries N√∫mero m√°ximo de reintentos
         * @returns {Promise<string>} La respuesta de texto de la IA
         */
        async function callGeminiAPI(prompt, maxRetries = 3) {
            const apiKey = ""; // Dejar vac√≠o, se gestiona en el entorno
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "Eres un profesor de matem√°ticas amigable y experto en trigonometr√≠a. Explica las propiedades de la funci√≥n que te da el usuario de forma clara, concisa y conceptual, como si fueras un tutor. **Estructura tu respuesta usando t√≠tulos claros (ej: 'An√°lisis de Amplitud:', 'An√°lisis del Per√≠odo:', 'Conclusi√≥n:', etc.) seguidos de su explicaci√≥n.** No uses markdown (como ** o #), solo texto plano y saltos de l√≠nea." }]
                }
            };

            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Error de red: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        // console.warn("Respuesta de la API inesperada:", result);
                        throw new Error("No se recibi√≥ contenido v√°lido de la API.");
                    }

                } catch (error) {
                    // console.error(`Intento ${attempt + 1} fallido:`, error);
                    attempt++;
                    if (attempt >= maxRetries) {
                        throw new Error(`Error al llamar a la API despu√©s de ${maxRetries} intentos: ${error.message}`);
                    }
                    // Espera exponencial (1s, 2s, 4s)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt - 1) * 1000));
                }
            }
            return "Lo siento, no pude contactar al asistente de IA en este momento.";
        }

        /**
         * Orquesta el an√°lisis de la IA
         */
        async function handleAIAnalysis() {
            showModal();
            showLoader();

            // 1. Obtener par√°metros y propiedades
            const params = readParameters();
            const amplitude = Math.abs(params.a);
            const period = (params.b === 0) ? 'Infinito' : (2 * Math.PI / Math.abs(params.b));
            const midline = `y = ${params.d.toFixed(2)}`;
            const range = `[${(params.d - amplitude).toFixed(2)}, ${(params.d + amplitude).toFixed(2)}]`;
            const equation = dynamicEquation.textContent; // Usar la ecuaci√≥n ya formateada

            // 2. Construir el prompt
            const prompt = `
Por favor, analiza la siguiente funci√≥n trigonom√©trica: ${equation}

Estas son sus propiedades calculadas:
- Amplitud: ${amplitude.toFixed(2)}
- Per√≠odo: ${period.toFixed(2)} (aprox. ${formatPi(period)})
- L√≠nea Media: ${midline}
- Rango: ${range}
- Desplazamiento de Fase (c): ${params.c.toFixed(2)}
- Frecuencia (b): ${params.b.toFixed(2)}

Explica qu√© significan estas propiedades para la gr√°fica. ¬øC√≥mo se transforma la funci√≥n padre (${params.funcType}) para convertirse en esta nueva funci√≥n?
S√© breve, conceptual y amigable.
`;

            // 3. Llamar a la API y mostrar el resultado
            try {
                const responseText = await callGeminiAPI(prompt);
                
                // --- MODIFICADO ---
                // Formatear la respuesta para mejor legibilidad
                // Reemplazar saltos de l√≠nea dobles (p√°rrafos) y luego simples
                const formattedResponse = responseText
                    .replace(/\n\n/g, '</p><p>') // Doble salto de l√≠nea es nuevo p√°rrafo
                    .replace(/\n/g, '<br>'); // Salto simple es <br>
                
                modalBody.innerHTML = `<div class="ai-response"><p>${formattedResponse}</p></div>`;
                // --- FIN DE MODIFICACI√ìN ---

            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-600"><b>Error:</b> ${error.message}</p>`;
            }
        }


        // --- EVENT LISTENERS ---

        // Eventos para sliders
        Object.values(sliders).forEach(slider => {
            slider.addEventListener('input', (e) => {
                const param = e.target.dataset.param;
                syncValueBox(e.target, values[param]);
                updateApplication(param);
                // Si se mueve un slider, se desactiva el preset
                if (activePreset) {
                    presets[activePreset].classList.remove('active');
                    activePreset = null;
                }
            });
        });
        
        // Eventos para value boxes
        Object.values(values).forEach(valueBox => {
            valueBox.addEventListener('change', (e) => {
                const param = e.target.id.replace('value', '').toLowerCase();
                syncSlider(sliders[param], e.target);
                updateApplication(param);
                if (activePreset) {
                    presets[activePreset].classList.remove('active');
                    activePreset = null;
                }
            });
        });
        
        // Eventos para radio buttons y checkboxes
        [funcSin, funcCos, checks.keyPoints, checks.solver].forEach(el => {
            el.addEventListener('change', () => updateApplication());
        });
        
        // Eventos para presets
        presets.noria.addEventListener('click', () => loadPreset('noria'));
        presets.marea.addEventListener('click', () => loadPreset('marea'));
        presets.reset.addEventListener('click', () => loadPreset('reset'));

        // --- Eventos de IA y Modal ---
        btnAnalyzeAI.addEventListener('click', handleAIAnalysis);
        modalCloseBtn.addEventListener('click', hideModal);
        aiModal.addEventListener('click', (e) => {
            // Cerrar si se hace clic en el overlay (fondo)
            if (e.target === aiModal) {
                hideModal();
            }
        });

        // --- INICIALIZACI√ìN ---
        initChart();
        loadPreset('reset'); // Cargar estado inicial
        updateApplication('reset');

    </script>
</body>
</html>
